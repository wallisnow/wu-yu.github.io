<!DOCTYPE html>
<html>
<head lang="zh-cn">
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,width=device-width,user-scalable=no">    

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">

    <title data-localize='bindNewCarTitle'></title>
    <link rel="stylesheet" type="text/css" href="../common/css/bootstrap.min.css">
    <link href="../common/css/font-awesome.min.css" rel="stylesheet">    
    <link href="../common/css/sweetalert.css" rel="stylesheet">    
    <link href="../common/css/common.css" rel="stylesheet">    



</head>

<style type="text/css">
    
    .stepSection{
        padding-top:30px;
        text-align: center;
    }

    .stepSection  .container{
        margin: 15px;
        padding: 0px 15px 10px 15px;
    }

    .hint{
        color:gray;
    }

    .stepSection  .input-group{
        margin: 0 auto;
    }

    .stepSection  .input-group .btn{
        padding: 2px 2px;
        border-radius: 0 0 0;
    }

    .btn-default:disabled{
        color: black;
    }



</style>

<body>

    <section id="bindCarSection" class="stepSection">
        
        <ul class="list-group fullWidthList">
            <li class="list-group-item">
            <div class="input-group">
                <input id="bindYZM" type="number" class="noborder_in fullwidth" required="required" data-localize="placeholder6">
                <span class="input-group-btn">
                <button id="sendYZM" class="btn btn-default" style="width:120px" type="button" data-localize="getValidatecode"></button>
                </span>
            </div>
            </li>
        </ul>       

        <div class="col-xs-12">
            <button id="submitBtn" class="btn btn-info btn-block" data-localize='bind'></button>
        </div>

    </section>
    
</body>

<script src="../common/js/jquery-1.11.0.min.js"></script>
<script src="../common/js/jquery.i18n.properties-min-1.0.9.js"></script>
<script src="../common/js/sweetalert.min.js"></script>
<script src='../common/js/native.js'></script>
<script src="../common/js/common.js"></script>
<script src='../common/js/msgAuthCode.js'></script>
<script src="../common/js/jquery.blockUI.js"></script>

<script>

$(function(){
    getCurrentUser();
})

$("#submitBtn").click(function(event) {
    var yzm = $('#bindYZM').val();
    var customerPhone = getParam('customerPhone');
    var vin = getParam('vin');
    //先校验验证码，校验通过再进行绑定操作
    validYZM(customerPhone,yzm).done(function(){
        if(areaCheck($("#bindCarSection"))){
            currentUser.vin = vin;
            bindCar(customerPhone)
        }
    })
});

//调用接口绑定新车
function bindCar(customerPhone){
    $.blockUI();
    $.ajax({
      url: window.TCManagePlantformServer + 'user/'+ currentUser.userId +'?operation=confirm'+'&clientId='+sessionStorage.registrationId,
      type: 'put',
      dataType: 'json',
      data: JSON.stringify({"vin":currentUser.vin,"userId":currentUser.userId}),
      contentType:'application/json',
      beforeSend:function(xhr){
          setAjaxHeaderTokens(xhr);
      }, 
      success: function(data) {
            console.log(JSON.stringify(data));        
            if(data.operationResult == 1){
                //有能力集，需要到IHU确认
                sendbindNewCarDirectiveSuccess();                                        
            }else if(data.operationResult == 0){
                //没有能力集，不用到IHU确认，直接绑定成功
                nativeToast($.i18n.prop('bindSuccess'),function(){
                    location.replace('./carSwitch.html');
                })                
            }else{
                nativeAlert($.i18n.prop(data.error.code));
            }                
      },
      complete:function(){
            $.unblockUI();
      }
    });
}

//发送车辆绑定指令到CSP成功
function sendbindNewCarDirectiveSuccess(){
    nativeAlert($.i18n.prop('bindTipInfo'),'',function(){
            location.replace('./index.html');
    });    
}


//发送验证码
$('#sendYZM').click(function(event) {
    sendPhoneYzm(getParam('customerPhone'),'sendYZM');
});

</script>
</html>